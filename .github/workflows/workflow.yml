name: workflow.yml
on: workflow_dispatch

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # Required for Workload Identity Federation
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4

      # Authenticate to Google Cloud
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        if: always()
        with:
          workload_identity_provider: 'projects/981170545333/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          service_account: 'github-actions-sa@project-25129d1b-c92f-49ae-a5a.iam.gserviceaccount.com'

      # Replace your upload step with these steps:
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        if: always()

      - name: Upload Playwright Report to GCS
        if: always()
        run: |
          # Upload all files
          gsutil -m rsync -r -d playwright-report gs://e2e-artifacts/playwright-reports/${{ github.run_id }}

      - name: Generate Signed URL
        if: always()
        run: |
          # Generate signed URL valid for 7 days
          run: |
            SIGNED_URL=$(gcloud storage sign-url \
            gs://e2e-artifacts/playwright-reports/${{ github.run_id }}/index.html \
            --duration=7d \
            --impersonate-service-account=github-actions-sa@project-25129d1b-c92f-49ae-a5a.iam.gserviceaccount.com)
          
          
          echo "ðŸ“Š Signed Report URL (valid for 7 days):"
          echo "$SIGNED_URL"
          
          # Add to GitHub Step Summary
          echo "## ðŸ“Š Playwright Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**[Click here to view the report]($SIGNED_URL)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ Link expires in 7 days" >> $GITHUB_STEP_SUMMARY